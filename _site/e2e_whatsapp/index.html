<!DOCTYPE html> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--> <!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"><!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <title>Whatsapp's E2E Encryption: How does it work in practice? &#8211; Amit Panghal</title> <meta name="description" content="Student @NYU Courant | IIT Bombay | Distributed Systems | Security | Applied Cryptography | Blockchain"> <meta name="keywords" content="whatsapp, Signal Protocol, cryptography, security"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://localhost:4000/assets/img/logo.png"> <meta name="twitter:title" content="Whatsapp's E2E Encryption: How does it work in practice?"> <meta name="twitter:description" content="How does signal protocol work?"> <meta name="twitter:site" content="@panghal_"> <meta name="twitter:creator" content="@panghal_"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Whatsapp's E2E Encryption: How does it work in practice?"> <meta property="og:description" content="How does signal protocol work?"> <meta property="og:url" content="http://localhost:4000/e2e_whatsapp/"> <meta property="og:site_name" content="Amit Panghal"> <meta property="og:image" content="http://localhost:4000/assets/img/logo.png"> <link rel="canonical" href="http://localhost:4000/e2e_whatsapp/"> <link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Amit Panghal Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css"> <!-- JS --> <script src="http://localhost:4000/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="http://localhost:4000/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- Background Image --> <style type="text/css">body {background-image:url(http://localhost:4000/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="http://localhost:4000/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="http://localhost:4000/assets/img/logo.png" alt="Amit Panghal photo" class="author-photo"> <h4>Amit Panghal</h4> <p>Student <a href="https://github.com/NYU" class="user-mention">@NYU</a> Courant | IIT Bombay | Distributed Systems | Security | Applied Cryptography | Blockchain</p> </li> <li><a href="http://localhost:4000/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="mailto:panghalamit1892@gmail.com" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-envelope-square"></i> Email</a> </li> <li> <a href="http://twitter.com/panghal_" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a> </li> <li> <a href="http://linkedin.com/in/panghalamit" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a> </li> <li> <a href="http://github.com/panghalamit" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul>
<!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="http://localhost:4000/posts/">All Posts</a></li> <li><a href="http://localhost:4000/tags/">All Tags</a></li> </ul> </li> <li><a href="http://localhost:4000/projects/">Projects</a></li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>Whatsapp's E2E Encryption: How does it work in practice?</h1> <h4>06 Oct 2018</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~11 minutes </p>
<!-- /.entry-reading-time --> <a class="btn zoombtn" href="http://localhost:4000/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <p>You must have heard about WhatsApp using end to end encryption. In layman’s words, every message that you sent to your friend, is encrypted on your device, this encrypted message passes through network and bunch of servers and reaches your friend’s device, and finally it is decrypted on friend’s device. So as long as underlying cryptography is intact, you can be assured that no one else other than your friend knows about your <a href="https://www.youtube.com/watch?v=gPDcwjJ8pLg">dirty little secret</a>. Is it as simple as it sounds?, No. Purpose of this post is to give you peak of what is actually happening behind the scene.</p> <h2 id="features-for-a-secure-messaging-system">Features for a secure messaging system</h2> <p>So what possible features such system should have? I will introduce a few characters in the system. I will chose Ankita, Bud and Mayank. (Cryptography literature uses Alice, Bob and Mallory. Name are chosen based on their roles). Ankita and Bud wants to exchange messages. Mayank is evil, and he wants to listen on the conversation between Ankita and Bud, and possibly want to send messages to Ankita acting as Bud and to Bud acting as Ankita. We want to our system to have following properties:</p> <ol> <li>Confidentiality : Mayank can’t know what messages Ankita and Bud send to each other.</li> <li>Integrity : If Bud receives a message from Ankita, He can check if the message was modified by Mayank on the way.</li> <li>Authenticity : When Bud receives a message from Ankita, He can be sure it is from Ankita and not from Mayank.</li> </ol> <p>Another feature that we might want is ‘deniability’, that is if someone recovers, Ankita’s or Bob’s old messages in future, it can’t be linked to them and they can deny having send that message.</p> <p>1) could be achieved using encryption/decryption mechanism. 2) and 3) could be achieved through MACs and Digital Signatures. These primitives require secure exchange of some secret (In case of Symmetric Key Cryptography) or establishment of each other’s public information (case of public key cryptography). Public Key Cryptography is nice in sense that you dont need to share a secret with someone you want to send message to, as long you know each other’s public key or (identity). Problem with that approach is that Ankita need to be assured that she actually has Bud’s public key and its not of Mayank’s and so She can securely communicate with Bud by encrypting the messages with Bud’s public key. Only Bud, who has the corresponding private key can decrypt the message. Similarly , In case of symmetric key cryptography, Mayank and Ankita need a mechanism to share the secret (May be meet in person and exchange), which they will use for encryption/decryption. In former case, it is okay if Mayank learns about Ankita and Bud’s public key (It’s Public).</p> <h2 id="whatsapp-e2e-encryption-protocol">WhatsApp E2E Encryption protocol?</h2> <p>Whatsapp uses open source <a href="https://en.wikipedia.org/wiki/Signal_Protocol">Signal Protocol</a> developed by <a href="https://signal.org">‘Open Whisper Systems’</a> (They have their own messaging application, Signal). Signal Protocol uses primitives like <a href="https://en.wikipedia.org/wiki/Double_Ratchet_Algorithm">Double Ratchet Algorithm</a>, prekeys, Triple <a href="https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange">Diffie Hellman</a> Handshake, <a href="https://en.wikipedia.org/wiki/Curve25519">Curve25519</a>, <a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES</a> and <a href="https://en.wikipedia.org/wiki/HMAC">HMAC_SHA256</a>.</p> <p>We will define these primitive before putting them all together to understand Signal Protocol.</p> <h2 id="understanding-primitives">Understanding Primitives</h2> <h3 id="prekeys">Prekeys</h3> <p>These are Curve25519 key pairs generated on device during install time. There is one Signed Prekey Pair and several one time prekey pairs. The Identity Public key and the Public keys of the prekey pairs are signed by a long term Identity Secret Key(Curve25519 private key correspond to Identity public key) and sent to server during registeration. Server stores these keys along with Identity Public key.</p> <h3 id="curve25519">Curve25519</h3> <p>Elliptic curve used as part of Diffie Hellman Key Exchange Protocol. I will discuss Elliptic Curve Cryptography in separate post. Its security is based on difficulty of discrete logarithm problem in Large Finite Groups.</p> <h3 id="diffie-hellman-key-agreement">Diffie Hellman Key Agreement</h3> <p>Diffie Hellman Key Agreement or Triple Diffie Hellman Handshake allows two parties to have a shared secret over public channel (Mayank is able to listen to message exchanged by Ankita and Bud). It is based on arthmetic modulo large prime p and it basically works as follows,</p> <ol> <li>Ankita and Bud agree on protocol parameters, large prime p and generator g. ‘g’ is the <a href="https://en.wikipedia.org/wiki/Primitive_root_modulo_n">generator</a> of multiplicative group ‘modulo p’. Generator is between 1 and p-1 and has this nice property, that every element in [1, p] can be represented as ‘g^k mod p’ where k is in [0,p-2].</li> <li>Ankita selects a random number ‘x’ between ‘1’ and ‘p-1’ , her private key.</li> <li>Bud selects a random number ‘y’ between ‘1’ and ‘p-1’, his private key.</li> <li>Ankita sends Bud, ‘x_p = g^x mod p’ , her public key.</li> <li>Bud sends Ankita ‘y_p = g^x mod p’, his public key.</li> <li>Ankita computes ‘ss_a = y_p^x mod p’</li> <li>Bud computes ‘ss_b = x_p^y mod p’</li> </ol> <p>After completion of protocol Ankita and Bud have a shared secret ‘ss_a = ss_b = g^(xy) mod p’ .</p> <p>Mayank on the network sees ‘x_p’ and ‘y_p’, and it is computationaly infeasible for him to determine shared secret without knowledge of ‘x’ or ‘y’ . We assume here that Mayank only see the messages on channel between Bud and Ankita but doesnt temper them.</p> <h3 id="extended-triple-diffie-hellman-key-agreement-x3dh">Extended Triple Diffie Hellman Key Agreement (X3DH)</h3> <p><a href="%22https://signal.org/docs/specifications/x3dh/%22">X3DH</a> is an extension of above protocol for asynchronous setting. Imagine Ankita wants to establish a shared key with Bud to send encrypted message to him. Above agreement works smoothly when Bud is online. What if Bud is offline?. She would have to wait for Bob to come online. Also, In above key agreement, Ankita and Bud have no way to determine if they are talking to each other. They may be both talking to Mayank thinking they are talking to each other. The protocol might end up as Ankita and Mayank sharing a secret, Mayank and Bud agreeing on a key. X3DH solves both these problems using a trusted third party and Prekeys. Ankita and Bud register signed prekeys (Signed using their long term private keys) on a trusted server. Each time one of them one wants to establish a shared secret with other, the former fetches the signed prekey bundle of latter. Lets assume Ankita is sender.</p> <p>Now, Ankita does her part, performs DH Operation (raising a public key with a private key, operation 5 in above) 3 or 4 times (depending on prekey she fetched from server). These operations are between,</p> <ol> <li>Ankita’s long term private key and Bud’s signed prekey.</li> <li>Ankita’s ephemeral private key (from key pair generated specifically for this exchnage and deleted afterwards) and Bud’s signed prekey.</li> <li>Ankita’s ephemeral private key and Bud’s long term public key.</li> <li>(if prekey bundle has a one time public key) Ankita’s ephemeral private key and Bud’s One time public key.</li> </ol> <figure> <a><img src="/assets/img/X3DH.png"></a> <figcaption>X3DH</figcaption> </figure> <p>The outputs from above steps are combined used as a key material i.e. master secret. These keys derived from master secret are used in Double Ratchet decribed below to send subsequent encrypted messages to Bud, all of them include Ankita’s ephemeral public key, long term identity key and information on which of the Bud’s one time public key is used ( in case it is in step 4.)are included in header (plaintext). This ends x3dh from Ankita’s side. The messages received by Bud if he is online or can be stored on server where Bud can fetch it later. When Bud receives the message later, he can derive the same master secret by using his private keys and Ankita’s public keys in the message header. This schemes allows Ankita and Bud to authenticate each other and derive shared secret to be used as key material.</p> <h3 id="hmac_sha256">HMAC_SHA256</h3> <p>It is keyed cryptographic hash function. Apart from the value to be hashed, this function also takes input a key. Unlike hash function which are easy to compute for a given input, keyed hash function require knowledge of the key. Here it is used as a key derivation function and MAC.</p> <h3 id="double-ratchet">Double Ratchet</h3> <p>‘Ratchet’ is name of a device that moves only in one direction. Double Ratchet uses two cryptographic Ratchets, i.e., deriving new keys from current keys and moving forward, while forgetting old keys. The two Ratchets used are Diffie-Hellman ratchet and symmetric ratchet. Each time a Diffie Hellman ratchet move forward, a secret is established between sender and receiver using Diffie Hellman described above, and the secret is used to derive two new keys (root key and chain key). Symmetric Ratchet moves forward by using a Key Derivation Function using chain key to generate a message key to encrypt message to be sent, and a chain key to be used for next ratchet movement. This ‘Ratcheting’ provides a useful property to protocol known as forward secrecy, i.e, if Ankita or Bud comprise their keys in future, their previous messages cant be comprised (decrypted), as long as ratchet works as expected (old keys are deleted).</p> <h2 id="putting-everything-together">Putting Everything Together</h2> <p>I have attempted to summarize the primitives used in the protocol which could be difficult to digest all at once. Assuming the primitives work as expected, following steps will describe the working of protocol in much simpler language. These steps occur when Ankita wants to send message to Bud using Whatsapp,</p> <ol> <li>Registeration of Clients with whatsapp server (Mobile apps on Ankita’s and Bud’s phone). It includes registering signed prekeys.</li> <li>Session setup by Ankita using x3dh</li> <li>In step 2, Ankita calculates master secret and Using DH Ratchet step, derives a root key and a chain key to be used Symmetric Ratchet.</li> <li>Ankita derives a message key and next chain key using the chain key using symmetric Ratchet.</li> <li>She encrypts her message using message key ( <a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES256 in CBC mode</a> ).</li> <li>Everytime she sends a message her Symmetric Ratchet moves forward.</li> <li>Everytime she receives a response from Bud, which includes a new public key in header, advances her DH Ratchet, calculates a new root key and a new chain key.</li> </ol> <p>On Bud’s side,</p> <ol> <li>When he retrives first message from Ankita, he completes the session setup by deriving the master secret, root key, chain key and the message key.</li> <li>Uses messages key to decrypt.</li> <li>If he wants to send message, he generates a new ephemeral pair, moves his DH ratchet forward using the root key and ephemeral private key and replaces hi chain key and message key.</li> <li>New message is derived from chain key and message is encrypted.</li> <li>encrypted message is sent with Bud’s ephemeral key in header.</li> </ol> <p>In the image below (Assuming it’s Ankita’s Phone), message in white boxes are one received and greens one are one sent. Each pair of continous boxes can help you visualize ratchet movements.</p> <ol> <li>White -&gt; White : Symmteric Ratchet of Bud moves forward by 1 step (new message key and next chain keys are derived)</li> <li>Green -&gt; Green : Symmetric Ratchet of Ankita moves forward by 1 step (she derives new message key and chain key)</li> <li>White -&gt; Green : Ankita’s DH Ratchet moves forward by 1 step(she derives new root key and chain key)</li> <li>Green -&gt; White : Bud’s DH Ratchet moves 1 step forwards (He derives new root key and chain key)</li> </ol> <figure> <a><img src="/assets/img/conv.png"></a> <figcaption>Screenshot of Ankita's Phone</figcaption> </figure> <h3 id="media-attachements-and-files">Media Attachements and Files</h3> <p>Media files are encrypted and uploaded to blob store. When Ankita sends an image or video to Bud, the pointer to the location of encrypted image or video file in blob store is encrypted and sent using above scheme.</p> <h3 id="group-messages">Group Messages</h3> <ol> <li>Whenever a group member sends his/her 1st message, he/she generates a sender key which is distributed to all group members using one-to-one protcol described above.</li> <li>For subsequent messages, messages are encrypted using new message key derived by symmetric Ratchet (this is different from one used in one-to-one).</li> <li>Since every member has other member’s sender key, they can move ratchet corresponding to sender to decrypt their messages.</li> <li>Whenever a member leaves the group, sender keys are renegotiated (step 1).</li> </ol> <h3 id="calling">Calling</h3> <p>Calling is synchronous/real-time. Whenever Ankita calls bud, she generates a random <a href="https://en.wikipedia.org/wiki/Secure_Real-time_Transport_Protocol">SRTP</a> secret. This secret is send to Bud using pairwise system. If he responds to call, encrypted session begins.</p> <h3 id="miscellaneous">Miscellaneous</h3> <p>Apart from the end to end encryption, the the channel between the whatsapp client and whatsapp server is secure. Plaintext Headers are not visible to anyone listing on channels. This is server’s extra wrapping over Ankita’s already wrapped gift(message) to Bud.</p> <h2 id="wrapping-up">Wrapping Up</h2> <p>So you might have heard people saying that Whatsapp is probably reading our messages, As you happen to see ads of things on your facebook feed which you happen to discuss on whatsapp chats. Lets cover some possibilities and conspiracy theories.</p> <ol> <li>If you trust that whatsapp’s end to end encryption is actually implemented as per signal specification, then no way they are able to read your chats. Unlike Signal application, whatsapp’s code is not open source so you can’t really confirm.</li> <li>Assuming signal protocol is implemented correctly, whatsapp servers know which whatsapp user is interacting with which user, how frequently, how recently. Same is true for signal app’s servers. If you have phone mobile registered on facebook and is the one use for whatsapp. They could use this information to associate your friend’s activity on facebook and serve you relevant ad which might come as surprise to you.</li> <li>They might have enough information from other channels and such an ad is merely an coincidence.</li> </ol> <h2 id="references-and-recommended-readings">References and Recommended Readings</h2> <ol> <li>Signal Developer <a href="https://signal.org/docs/">Docs</a>
</li> <li>Signal <a href="https://signal.org/blog/">Blogs</a>
</li> <li>Whatsapp <a href="https://www.whatsapp.com/security/WhatsApp-Security-Whitepaper.pdf">whitepaper</a>
</li> <li>Diffie Hellman simple <a href="https://www.youtube.com/watch?v=YEBfamv-_do&amp;feature=youtu.be">explanation</a>
</li> <li>Off the record messaging, <a href="https://en.wikipedia.org/wiki/Off-the-Record_Messaging">OTR</a>
</li> </ol> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="http://localhost:4000/tags/#whatsapp" title="Pages tagged whatsapp" class="tag"><span class="term">whatsapp</span></a><a href="http://localhost:4000/tags/#Signal%20Protocol" title="Pages tagged Signal Protocol" class="tag"><span class="term">Signal Protocol</span></a><a href="http://localhost:4000/tags/#cryptography" title="Pages tagged cryptography" class="tag"><span class="term">cryptography</span></a><a href="http://localhost:4000/tags/#security" title="Pages tagged security" class="tag"><span class="term">security</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/e2e_whatsapp/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/e2e_whatsapp/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=http://localhost:4000/e2e_whatsapp/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="http://localhost:4000/assets/js/jquery-1.12.0.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.dlmenu.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.goup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.magnific-popup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.fitvid.min.js"></script> <script src="http://localhost:4000/assets/js/scripts.js"></script> <script type="text/javascript"> var disqus_shortname = 'panghal'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
